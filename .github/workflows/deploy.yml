name: Deploy to VPS

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # 1Ô∏è‚É£ Checkout kode repository
    # -----------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # -----------------------------
    # 2Ô∏è‚É£ Validasi Docker Compose
    # -----------------------------
    - name: Validate Docker Compose
      run: docker compose -f docker-compose.yml config

    # -----------------------------
    # 3Ô∏è‚É£ Setup Python untuk linting
    # -----------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # -----------------------------
    # 4Ô∏è‚É£ Jalankan lint check (opsional)
    # -----------------------------
    - name: Lint with Flake8
      run: |
        pip install flake8
        flake8 backend/ --count --select=E9,F63,F7,F82 --show-source --statistics

    # -----------------------------
    # 5Ô∏è‚É£ Deploy ke VPS via SSH
    # -----------------------------
    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ Starting deployment to VPS..."
          cd ~/Whatsapp_Bot
          echo "üì¶ Pulling latest code..."
          git pull origin master
          echo "‚öôÔ∏è Rebuilding Docker containers..."
          docker-compose build backend
          echo "üß± Restarting Docker services..."
          docker-compose up -d --remove-orphans
          echo "‚úÖ Deployment finished successfully!"
